---
title: '508 Final: Heroin Overdose Prediction'
author: "Jingyi Li & Sihan Ren"
date: "2023-11-29"
output: html_document
---

## Set Up

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(RSocrata)
library(viridis)
library(spatstat.explore)
library(raster)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(classInt)
```

## Project

|    Predict drug overdose events to better allocate prevention resources in Mesa.

## Use case

|    Use the predictions generated by the model to identify areas or demographics with a higher risk of drug overdose. Raising more attention of the healthcare professionals, public health agencies, law enforcement, and community organizations on these high-risk areas. Also urging Policy makers to allocate prevention resources, such as outreach programs, naloxone distribution, and treatment facilities, to these high-risk areas.

## Methods

(1) Find Data: crime, grafitti, homelessness, income, unemployment, race, education level as predictors od drug overdose.

(2) Run models(OLS?GWR?Spatial?) to explore the relationship between the predictors and dependent vairable

(3) Validate model accuracy

(4) Analyze the result and conclude with feasibility of the model

## Data

```{r cars}
drugOverdose<-read.csv("DATA/Fire_and_Medical_Opioid_Overdose_Incidents.csv")%>%
  mutate(X = as.numeric(Longitude),Y = as.numeric(Latitude)) %>% 
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
    st_transform('EPSG:2223')
crime<-read.csv("DATA/Police_Incidents.csv")%>%
  filter(Report.Year=="2020")%>% 
  mutate(X = as.numeric(Longitude),Y = as.numeric(Latitude)) %>% 
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
    st_transform('EPSG:2223')
graffitti<- read.csv("DATA/Transportation_Graffiti_20231129.csv")%>%
  mutate(X = as.numeric(Longitude),Y = as.numeric(Latitude)) %>% 
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
    st_transform('EPSG:2223')
homeless<-read.csv("DATA/Unsheltered_Point_in_Time__PIT__Count_Phoenix_Metro_Area_20231129.csv")%>%
  mutate(X = as.numeric(Longitude),Y = as.numeric(Latitude)) %>% 
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
    st_transform('EPSG:2223')

census20<-  get_acs(geography = "block group",
          variables = c("B19013_001E",# medHH income
                        "B01003_001E",#total pop
                        "B15003_022E",# bachelor or more
                        "B23025_005E",# unemployed
                        "B02001_002E",# white alone
                        "B02001_003E"),#black alone
          year=2020, state=04,
          county=13, geometry=TRUE) %>% 
  st_transform('EPSG:2223')

census20<-census20%>%
  dplyr::select( -NAME, -moe) %>%
  spread(key = variable, value = estimate) %>%
  rename(TotalPop = B01003_001, 
         MedHHInc = B19013_001, 
         BachMore = B15003_022,
         Unemploy = B23025_005,
         BlackAlone = B02001_003,
         WhiteAlone = B02001_002
         )

census20<- 
  census20 %>%
  mutate(pctUnemploy = ifelse(TotalPop > 0, Unemploy / TotalPop, 0),
         pctWhite = ifelse(TotalPop > 0, (WhiteAlone / TotalPop), 0),
         pctBlack = ifelse(TotalPop > 0, (BlackAlone / TotalPop), 0),
         pctBachMore= ifelse(TotalPop>0, (BachMore / TotalPop), 0),
         year = "2020") %>%
  dplyr::select(-BachMore,-Unemploy,-BlackAlone,-WhiteAlone)

mesaBoundary<- st_read("https://services2.arcgis.com/1gVyYKfYgW5Nxb1V/arcgis/rest/services/CityBoundary/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson")%>%
  st_transform('EPSG:2223')
```

## Exploratory analysis

### Point and density graph of drug overdose

```{r echo=TRUE,results='hide', message=FALSE, warning=FALSE}
grid.arrange(ncol=2,
ggplot() + 
  geom_sf(data = mesaBoundary) +
  geom_sf(data = drugOverdose, colour="red", size=0.1, show.legend = "point") +
  labs(title= "Drug Overdose, Mesa - 2020") +
  theme(plot.title = element_text(size = 14),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank()),

ggplot() + 
  geom_sf(data = mesaBoundary, fill = "grey40") +
  stat_density2d(data = data.frame(st_coordinates(drugOverdose)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_viridis() +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title = "Density of Drug Overdose") +
  theme(plot.title = element_text(size = 14),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank()) + theme(legend.position = "none"))
```

## Creating Fishnet 

```{r fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
fishnet <- 
  st_make_grid(mesaBoundary,
               cellsize = 500, 
               square = TRUE) %>%
  .[mesaBoundary] %>%            # fast way to select intersecting polygons
  st_sf() %>%
  mutate(uniqueID = 1:n())
fishnet
```

## Join Points to Fishnet  

```{r}
drugNet <- 
  dplyr::select(drugOverdose) %>% 
  mutate(countOverdose = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countOverdose = replace_na(countOverdose, 0),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))

ggplot() +
  geom_sf(data = drugNet, aes(fill = countOverdose)) +
  scale_fill_viridis() +
  labs(title = "Count of Drug Overdose for the Fishnet")+
  theme_minimal()
```

## Join Risk Factors into Fishnet

```{r}
vars_net <- 
  rbind(crime, graffitti, homeless,census20) %>%
  st_join(fishnet, join = st_within) %>%
  st_drop_geometry() %>%
  group_by(uniqueID, Legend) %>%
  summarize(count = n()) %>%
  full_join(fishnet) %>%
  spread(Legend, count, fill = 0) %>%
  st_as_sf() %>%
  dplyr::select(-`<NA>`) %>%
  na.omit() %>%
  ungroup()
```

