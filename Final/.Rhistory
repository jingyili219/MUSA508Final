knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(RSocrata)
library(viridis)
library(spatstat.explore)
library(raster)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(classInt)
drugOverdose<-read.csv("DATA/Fire_and_Medical_Opioid_Overdose_Incidents.csv")%>%
mutate(X = as.numeric(Longitude),Y = as.numeric(Latitude)) %>%
na.omit() %>%
st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
st_transform('EPSG:2223')
mesaBoundary<- st_read("https://services2.arcgis.com/1gVyYKfYgW5Nxb1V/arcgis/rest/services/CityBoundary/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson")%>%
st_transform('EPSG:2223')
census20<-  get_acs(geography = "block group",
variables = c("B19013_001E",# medHH income
"B01003_001E",#total pop
"B15003_022E",# bachelor or more
"B23025_005E",# unemployed
"B02001_002E",# white alone
"B02001_003E"),#black alone
year=2020, state=04,
county=13, geometry=TRUE) %>%
st_transform('EPSG:2223')
census20<-census20%>%
dplyr::select( -NAME, -moe) %>%
spread(key = variable, value = estimate) %>%
rename(TotalPop = B01003_001,
MedHHInc = B19013_001,
BachMore = B15003_022,
Unemploy = B23025_005,
BlackAlone = B02001_003,
WhiteAlone = B02001_002
)
census20<-
census20 %>%
mutate(pctUnemploy = ifelse(TotalPop > 0, Unemploy / TotalPop, 0),
pctWhite = ifelse(TotalPop > 0, (WhiteAlone / TotalPop), 0),
pctBlack = ifelse(TotalPop > 0, (BlackAlone / TotalPop), 0),
pctBachMore= ifelse(TotalPop>0, (BachMore / TotalPop), 0),
year = "2020") %>%
dplyr::select(-BachMore,-Unemploy,-BlackAlone,-WhiteAlone)
filtered_Overdose <- st_intersection(drugOverdose, mesaBoundary)
grid.arrange(ncol=2,
ggplot() +
geom_sf(data = mesaBoundary) +
geom_sf(data = filtered_Overdose, colour="red", size=0.1, show.legend = "point") +
labs(title= "Drug Overdose, Mesa - 2020") +
theme(plot.title = element_text(size = 14),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank()),
ggplot() +
geom_sf(data = mesaBoundary, fill = "grey40") +
stat_density2d(data = data.frame(st_coordinates(filtered_Overdose)),
aes(X, Y, fill = ..level.., alpha = ..level..),
size = 0.01, bins = 40, geom = 'polygon') +
scale_fill_viridis() +
scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
labs(title = "Density of Drug Overdose") +
theme(plot.title = element_text(size = 14),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank()) + theme(legend.position = "none"))
fishnet <-
st_make_grid(mesaBoundary,
cellsize = 500,
square = TRUE) %>%
.[mesaBoundary] %>%            # fast way to select intersecting polygons
st_sf() %>%
mutate(uniqueID = 1:n())
fishnet
drugNet <-
dplyr::select(filtered_Overdose) %>%
mutate(countOverdose = 1) %>%
aggregate(., fishnet, sum) %>%
mutate(countOverdose = replace_na(countOverdose, 0),
uniqueID = rownames(.),
cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))
ggplot() +
geom_sf(data = drugNet, aes(fill = countOverdose)) +
scale_fill_viridis() +
labs(title = "Count of Drug Overdose for the Fishnet")+
theme_minimal()
View(drugNet)
drugNet <-
dplyr::select(filtered_Overdose) %>%
mutate(countOverdose = 1) %>%
aggregate(., fishnet, sum) %>%
mutate(countOverdose = replace_na(countOverdose, 0),
uniqueID = rownames(.),
cvID = sample(round(nrow(fishnet) / 12), size=nrow(fishnet), replace = TRUE))
ggplot() +
geom_sf(data = drugNet, aes(fill = countOverdose)) +
scale_fill_viridis() +
labs(title = "Count of Drug Overdose for the Fishnet")+
theme_minimal()
fishnet <-
st_make_grid(mesaBoundary,
cellsize = 200,
square = TRUE) %>%
.[mesaBoundary] %>%            # fast way to select intersecting polygons
st_sf() %>%
mutate(uniqueID = 1:n())
fishnet
drugNet <-
dplyr::select(filtered_Overdose) %>%
mutate(countOverdose = 1) %>%
aggregate(., fishnet, sum) %>%
mutate(countOverdose = replace_na(countOverdose, 0),
uniqueID = rownames(.),
cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))
ggplot() +
geom_sf(data = drugNet, aes(fill = countOverdose)) +
scale_fill_viridis() +
labs(title = "Count of Drug Overdose for the Fishnet")+
theme_minimal()
fishnet <-
st_make_grid(mesaBoundary,
cellsize = 1000,
square = TRUE) %>%
.[mesaBoundary] %>%            # fast way to select intersecting polygons
st_sf() %>%
mutate(uniqueID = 1:n())
fishnet
drugNet <-
dplyr::select(filtered_Overdose) %>%
mutate(countOverdose = 1) %>%
aggregate(., fishnet, sum) %>%
mutate(countOverdose = replace_na(countOverdose, 0),
uniqueID = rownames(.),
cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))
ggplot() +
geom_sf(data = drugNet, aes(fill = countOverdose)) +
scale_fill_viridis() +
labs(title = "Count of Drug Overdose for the Fishnet")+
theme_minimal()
fishnet <-
st_make_grid(mesaBoundary,
cellsize = 1500,
square = TRUE) %>%
.[mesaBoundary] %>%            # fast way to select intersecting polygons
st_sf() %>%
mutate(uniqueID = 1:n())
fishnet
drugNet <-
dplyr::select(filtered_Overdose) %>%
mutate(countOverdose = 1) %>%
aggregate(., fishnet, sum) %>%
mutate(countOverdose = replace_na(countOverdose, 0),
uniqueID = rownames(.),
cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))
ggplot() +
geom_sf(data = drugNet, aes(fill = countOverdose)) +
scale_fill_viridis() +
labs(title = "Count of Drug Overdose for the Fishnet")+
theme_minimal()
#Risk Factors Data
crime<-read.socrata("https://data.mesaaz.gov/Police/Police-Incidents/39rt-2rfj")%>%
mutate(year = substr(report_date,1,4)) %>% filter(year == "2020") %>%
dplyr::select(Y = latitude, X = longitude) %>%
na.omit() %>%
st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
st_transform(st_crs(fishnet)) %>%
mutate(Legend = "crime")
graffiti<- read.csv("DATA/Transportation_Graffiti_20231129.csv")%>%
mutate(year = substr(Date.Reported,1,4))%>%
dplyr::select(Y = Latitude, X = Longitude) %>%
na.omit() %>%
st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
st_transform(st_crs(fishnet)) %>%
mutate(Legend = "graffiti")
homeless<-read.csv("DATA/Unsheltered_Point_in_Time__PIT__Count_Phoenix_Metro_Area_20231129.csv")%>%
mutate(year = substr(Reporting.Date,1,4))%>%
dplyr::select(Y = Latitude, X = Longitude) %>%
na.omit() %>%
st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
st_transform(st_crs(fishnet)) %>%
mutate(Legend = "homeless")
vars_net <-
rbind(crime,graffiti, homeless) %>%
st_join(fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(uniqueID, Legend) %>%
summarize(count = n()) %>%
full_join(fishnet) %>%
spread(Legend, count, fill = 0) %>%
st_as_sf() %>%
dplyr::select(-`<NA>`) %>%
na.omit() %>%
ungroup()
vars_net.long <-
gather(vars_net, Variable, value, -geometry, -uniqueID)
vars <- unique(vars_net.long$Variable)
mapList <- list()
for(i in vars){
mapList[[i]] <-
ggplot() +
geom_sf(data = filter(vars_net.long, Variable == i), aes(fill=value), colour=NA) +
scale_fill_viridis(name="") +
labs(title=i) +
theme(axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank())}
do.call(grid.arrange,c(mapList, ncol=3, top="Risk Factors by Fishnet"))
st_c    <- st_coordinates
st_coid <- st_centroid
# create NN for alley light out and bars
vars_net <-
vars_net %>%
mutate(
crime.nn =
nn_function(st_c(st_coid(vars_net)), st_c(crime),3),
graffiti.nn =
nn_function(st_c(st_coid(vars_net)), st_c(graffiti),3),
homeless.nn =
nn_function(st_c(st_coid(vars_net)), st_c(homeless),3))
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(RSocrata)
library(viridis)
library(spatstat.explore)
library(raster)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(classInt)
options(tigris_class = "sf")
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
st_c    <- st_coordinates
st_coid <- st_centroid
# create NN for alley light out and bars
vars_net <-
vars_net %>%
mutate(
crime.nn =
nn_function(st_c(st_coid(vars_net)), st_c(crime),3),
graffiti.nn =
nn_function(st_c(st_coid(vars_net)), st_c(graffiti),3),
homeless.nn =
nn_function(st_c(st_coid(vars_net)), st_c(homeless),3))
View(crime)
crime <- st_c(crime)
#Risk Factors Data
crime<-read.socrata("https://data.mesaaz.gov/Police/Police-Incidents/39rt-2rfj")%>%
mutate(year = substr(report_date,1,4)) %>% filter(year == "2020") %>%
dplyr::select(Y = latitude, X = longitude) %>%
na.omit() %>%
st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
st_transform(st_crs(fishnet)) %>%
mutate(Legend = "crime")
graffiti<- read.csv("DATA/Transportation_Graffiti_20231129.csv")%>%
mutate(year = substr(Date.Reported,1,4))%>%
dplyr::select(Y = Latitude, X = Longitude) %>%
na.omit() %>%
st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
st_transform(st_crs(fishnet)) %>%
mutate(Legend = "graffiti")
homeless<-read.csv("DATA/Unsheltered_Point_in_Time__PIT__Count_Phoenix_Metro_Area_20231129.csv")%>%
mutate(year = substr(Reporting.Date,1,4))%>%
dplyr::select(Y = Latitude, X = Longitude) %>%
na.omit() %>%
st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
st_transform(st_crs(fishnet)) %>%
mutate(Legend = "homeless")
View(crime)
crime_coordinates <- st_c(crime)
View(crime_coordinates)
vars_net_coordinates <- st_c(st_coid(vars_net))
View(vars_net_coordinates)
st_c    <- st_coordinates
st_coid <- st_centroid
crime_coordinates <- st_c(crime)
vars_net_coordinates <- st_c(st_coid(vars_net))
# create NN for alley light out and bars
vars_net <-
vars_net %>%
mutate(
crime.nn =
nn_function(vars_net_coordinates, crime_coordinates,3),
# graffiti.nn =
#   nn_function(st_c(st_coid(vars_net)), st_c(graffiti),3),
# homeless.nn =
#   nn_function(st_c(st_coid(vars_net)), st_c(homeless),3)
)
#plot multiple maps using for loop
vars_net.long.nn <-
dplyr::select(vars_net, ends_with(".nn")) %>%
gather(Variable, value, -geometry)
vars <- unique(vars_net.long.nn$Variable)
mapList <- list()
for(i in vars){
mapList[[i]] <-
ggplot() +
geom_sf(data = filter(vars_net.long.nn, Variable == i), aes(fill=value), colour=NA) +
scale_fill_viridis(name="") +
labs(title=i) +
theme_classic()}
do.call(grid.arrange,c(mapList, ncol = 3, top = "Nearest Neighbor risk Factors by Fishnet"))
View(vars_net)
st_c    <- st_coordinates
st_coid <- st_centroid
crime_coordinates <- st_c(crime)
graffiti_coordinates <- st_c(graffiti)
homeless_coordinates <- st_c(homeless)
vars_net_coordinates <- st_c(st_coid(vars_net))
# create NN for alley light out and bars
vars_net <-
vars_net %>%
mutate(
crime.nn =
nn_function(vars_net_coordinates, crime_coordinates,3),
graffiti.nn =
nn_function(vars_net_coordinates, graffiti_coordinates,3),
homeless.nn =
nn_function(vars_net_coordinates, homeless_coordinates,3)
)
#plot multiple maps using for loop
vars_net.long.nn <-
dplyr::select(vars_net, ends_with(".nn")) %>%
gather(Variable, value, -geometry)
vars <- unique(vars_net.long.nn$Variable)
mapList <- list()
for(i in vars){
mapList[[i]] <-
ggplot() +
geom_sf(data = filter(vars_net.long.nn, Variable == i), aes(fill=value), colour=NA) +
scale_fill_viridis(name="") +
labs(title=i) +
theme_classic()}
do.call(grid.arrange,c(mapList, ncol = 3, top = "Nearest Neighbor risk Factors by Fishnet"))
